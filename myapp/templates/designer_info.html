{% extends "common.html" %}
{% load static %}
{% block content %}

<div class="container-fluid pb-5 bg-primary justify-content-center hero-header" >
    <div class="container py-5">
        <div class="row g-3 align-items-center">
            <div class="col-lg-6 text-center text-lg-start">
                <div style="position: absolute; left: 600px; top: 180px;">
                    {% if designer.uprofile %}
                            <img src="{{ designer.uprofile.url }}" class="rounded-circle shadow" style="width: 300px; height: 300px; object-fit: cover; border:2px solid black">
                        {% else %}
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSnSSxXHLqu5lsHYkFlZkvXuo2ZamNvdqLiCg&s" class="rounded-circle shadow" style="width: 300px; height: 300px; border:2px solid black"">
                        {% endif %}
                </div>
                <h1 class="display-1 mb-0 animated slideInLeft">Name : {{designer.name}}</h1><br>
                <h4 class="display-10 mb-0 animated slideInLeft" style="margin-left: 10px;">Contact : {{designer.contact}}</h4><br>
                <h4 class="display-10 mb-0 animated slideInLeft" style="margin-left: 10px;">Email : {{designer.email}}</h4><br>
                <h4 class="display-10 mb-0 animated slideInLeft" style="margin-left: 10px;">Consultation
                    Fees : <b>â‚¹ {{designer.consultation_fee}} /-</b></h4>
            </div>
            <div class="col-lg-6 animated slideInRight mt-lg-5">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center justify-content-lg-end mb-0">
                        <li class="breadcrumb-item"><a class="text-primary" href="#!">Home</a></li>
                        <li class="breadcrumb-item"><a class="text-primary" href="#!">Pages</a></li>
                        <li class="breadcrumb-item text-secondary active" aria-current="page">Designer Details</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <button style="background-color:teal;color: white;height: 60px;width: 20%;font-size: x-large;border: none;border-radius: 50px;margin-left: 100px;" data-bs-toggle="modal" data-bs-target="#exampleModal">Continue Booking</button>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Site to be Visited ?</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addressForm">
                             {% csrf_token %}
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="form-floating">
                                            <select class="form-control" name="sitetype" required>
                                                <option value="" selected>Select Purpose ?</option>
                                                <option value="Residential">Residential</option>
                                                <option value="Commercial">Commercial</option>
                                            </select>  
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="address" name="address" placeholder="Your address">
                                        <label for="address">Your Address</label>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="pincode" name="pincode" placeholder="Pincode" maxlength="6" onkeyup="fetchAddress()">
                                        <label for="pincode">Pincode</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="city" name="city" placeholder="City" >
                                        <label for="city">City/District</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="state" name="state" placeholder="State" >
                                        <label for="state">State</label>
                                    </div>
                                </div>
                            </div>
      </div>
      <div class="modal-footer col-12">
        <button type="submit" class="btn btn-primary w-100 py-3">Save & Proceed to Payment</button>
      </div>
      </form>
    </div>
  </div>
</div>
</div>

<script>
    function fetchAddress() {
    let pincode = document.getElementById("pincode").value;

    // Only call the API when the length is exactly 6
    if (pincode.length === 6) {
        let url = `https://api.postalpincode.in/pincode/${pincode}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data[0].Status === "Success") {
                    let postOffice = data[0].PostOffice[0];
                    document.getElementById("city").value = postOffice.District;
                    document.getElementById("state").value = postOffice.State;
                } else {
                    alert("Invalid Pincode! Please check again.");
                    document.getElementById("city").value = "";
                    document.getElementById("state").value = "";
                }
            })
            .catch(err => console.log("API Error:", err));
    }
}

document.getElementById('addressForm').onsubmit = function(e) {
    e.preventDefault();
    
    const data = {
        pincode: document.getElementById('pincode').value,
        address: document.getElementById('address').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        site_type : document.getElementById('sitetype').value
        
    };

    // 2. Send to Django via Fetch/AJAX
    fetch('/save-site-and-create-order/', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(res => res.json())
    .then(response => {
        // 3. Trigger Razorpay directly from here!
        openRazorpay(response.order_id, response.amount);
    });
};
</script>


    <!-- Footer Start -->
    {% endblock %}
   